# Rate limiting zones - these will be added by nginx automatically when this file is in conf.d/
# The nginx base image includes these in the main config, so we can reference them
map $binary_remote_addr $limit_key {
    default $binary_remote_addr;
}

# Define rate limiting zones (these work in server context when nginx doesn't have them globally)
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

server {
  listen 8080;
  
  # Connection limits
  limit_conn conn_limit_per_ip 20;
  
  # Slowloris protection - Timeout configurations
  client_body_timeout 10s;           # Time to read client request body
  client_header_timeout 10s;         # Time to read client request headers
  keepalive_timeout 5s 5s;           # Keep-alive timeout (5s for requests, 5s for responses)
  send_timeout 10s;                  # Time to send response to client
  
  # Connection limits
  client_max_body_size 300M;
  client_body_buffer_size 128k;      # Buffer size for client request body
  client_header_buffer_size 1k;      # Buffer size for client request headers
  large_client_header_buffers 4 4k;  # Buffer for large headers
  
  # Additional security settings
  reset_timedout_connection on;      # Reset connections on timeout
  tcp_nodelay on;                    # Disable Nagle's algorithm
  tcp_nopush on;                     # Optimize TCP packets

  # Security Headers - Set at nginx level as backup
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Frame-Options "DENY" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), bluetooth=(), clipboard-read=(), clipboard-write=(), display-capture=(), fullscreen=(self), gamepad=(), hid=(), idle-detection=(), local-fonts=(), midi=(), nfc=(), notifications=(), persistent-storage=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), serial=(), speaker-selection=(), storage-access=(), sync-xhr=(), unoptimized-images=(), usb=(), vertical-scroll=(), web-share=(), xr-spatial-tracking=()" always;

  location /docs {
    # Rate limiting for documentation
    limit_req zone=general burst=10 nodelay;
    limit_conn conn_limit_per_ip 5;
    
    proxy_pass http://fastapi-server:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Proxy timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # CSP for Swagger UI
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self'; frame-ancestors 'none';" always;

    rewrite ^/docs(/.*)$ /docs$1 break;
  }

  location /api/v1 {
    # Rate limiting for API endpoints
    limit_req zone=api burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    proxy_pass http://fastapi-server:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Proxy timeouts to prevent backend connection exhaustion
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # Strict CSP for API endpoints
    add_header Content-Security-Policy "default-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';" always;

    rewrite ^/api/v1(/.*)$ /api/v1$1 break;
  }

  location /api/v2 {
    # Rate limiting for API endpoints
    limit_req zone=api burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    proxy_pass http://fastapi-server:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Proxy timeouts to prevent backend connection exhaustion
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # Strict CSP for API endpoints
    add_header Content-Security-Policy "default-src 'none'; frame-ancestors 'none'; base-uri 'none'; form-action 'none';" always;

    rewrite ^/api/v2(/.*)$ /api/v2$1 break;
  }

  location /ws/ {
    # Rate limiting for WebSocket connections
    limit_req zone=general burst=5 nodelay;
    limit_conn conn_limit_per_ip 3;
    
    proxy_pass http://fastapi-server:8000/ws/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-NginX-Bypass 1;
    
    # WebSocket specific timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }
    
  # Catch-all location for other requests - proxy to backend instead of 404
  location / {
    limit_req zone=general burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    # Proxy to backend for any unmatched requests
    proxy_pass http://fastapi-server:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Proxy timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }
}